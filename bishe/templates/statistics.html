{% extends "base.html" %}
{% block title %}ç»Ÿè®¡ä¿¡æ¯ - æ ¡å›­å¤±ç‰©æ‹›é¢†å¹³å°{% endblock %}

{% block content %}
<div class="page-title">
  <h2>ç»Ÿè®¡ä¿¡æ¯</h2>
  <p>æŸ¥çœ‹å¹³å°æ•°æ®ç»Ÿè®¡ï¼Œäº†è§£å¤±ç‰©æ‹›é¢†æƒ…å†µ ğŸ“Š</p>
</div>

{# ---------- é¡¶éƒ¨æ¦‚è§ˆå¡ç‰‡ ---------- #}
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem;margin-bottom:2rem;">
  <div class="card" style="text-align:center;background:linear-gradient(135deg,#ff9a9e 0%,#fad0c4 100%);color:#721c24;border:none;">
    <div style="font-size:3rem;margin-bottom:.5rem;">ğŸ”</div>
    <h3 class="kpi" data-target="{{ total_lost|default(0) }}" style="font-size:2rem;margin-bottom:.5rem;">{{ total_lost|default(0) }}</h3>
    <p style="font-size:1.1rem;font-weight:500;">é—å¤±ç‰©å“</p>
  </div>

  <div class="card" style="text-align:center;background:linear-gradient(135deg,#84fab0 0%,#8fd3f4 100%);color:#155724;border:none;">
    <div style="font-size:3rem;margin-bottom:.5rem;">ğŸ“¦</div>
    <h3 class="kpi" data-target="{{ total_found|default(0) }}" style="font-size:2rem;margin-bottom:.5rem;">{{ total_found|default(0) }}</h3>
    <p style="font-size:1.1rem;font-weight:500;">æ‹¾åˆ°ç‰©å“</p>
  </div>

  {% set all_total = (total_lost|default(0)) + (total_found|default(0)) %}
  <div class="card" style="text-align:center;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;">
    <div style="font-size:3rem;margin-bottom:.5rem;">ğŸ“ˆ</div>
    <h3 class="kpi" data-target="{{ all_total }}" style="font-size:2rem;margin-bottom:.5rem;">{{ all_total }}</h3>
    <p style="font-size:1.1rem;font-weight:500;">æ€»è®¡ä¿¡æ¯</p>
  </div>

  <div class="card" style="text-align:center;background:linear-gradient(135deg,#ffecd2 0%,#fcb69f 100%);color:#8b4513;border:none;">
    <div style="font-size:3rem;margin-bottom:.5rem;">ğŸ¯</div>
    {% set rate = 0 if all_total==0 else (total_found / all_total * 100) %}
    <h3 style="font-size:2rem;margin-bottom:.5rem;">{{ '%.1f'|format(rate) }}%</h3>
    <p style="font-size:1.1rem;font-weight:500;">æ‰¾å›ç‡</p>
  </div>
</div>

{# ---------- ç±»åˆ«ç»Ÿè®¡ ---------- #}
<div class="card">
  <h3 style="color:#2c3e50;margin-bottom:1.5rem;text-align:center;">ğŸ“Š ç‰©å“ç±»åˆ«ç»Ÿè®¡</h3>

  <div style="display:grid;gap:1rem;">
    {% for category in lost_stats.keys() %}
      {% set lost_count  = lost_stats[category]|default(0) %}
      {% set found_count = found_stats[category]|default(0) %}
      {% set total = lost_count + found_count %}
      {% if total > 0 %}
      <div style="background:#f8f9fa;padding:1.5rem;border-radius:10px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
          <div style="display:flex;align-items:center;gap:1rem;">
            <div style="font-size:2rem;">
              {% if category == 'é’±åŒ…' %}ğŸ’°
              {% elif category == 'é’¥åŒ™' %}ğŸ”‘
              {% elif category == 'ä¹¦ç±' %}ğŸ“š
              {% elif category == 'ç”µå­äº§å“' %}ğŸ“±
              {% else %}ğŸ“¦{% endif %}
            </div>
            <h4 style="color:#2c3e50;">{{ category }}</h4>
          </div>
          <div style="text-align:right;">
            <div style="font-size:1.2rem;font-weight:bold;color:#667eea;">{{ total }} ä»¶</div>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
          <div style="text-align:center;padding:1rem;background:rgba(255,154,158,.1);border-radius:8px;">
            <div style="font-size:1.5rem;font-weight:bold;color:#dc3545;margin-bottom:.5rem;">{{ lost_count }}</div>
            <div style="color:#666;">é—å¤±</div>
          </div>
          <div style="text-align:center;padding:1rem;background:rgba(132,250,176,.1);border-radius:8px;">
            <div style="font-size:1.5rem;font-weight:bold;color:#28a745;margin-bottom:.5rem;">{{ found_count }}</div>
            <div style="color:#666;">æ‹¾åˆ°</div>
          </div>
        </div>

        {# è¿›åº¦æ¡ï¼šæŒ‰æ¯”ä¾‹å±•ç¤º #}
        {% set lost_pct  = 0 if total==0 else (lost_count/total*100) %}
        {% set found_pct = 100 - lost_pct %}
        <div style="margin-top:1rem;">
          <div style="background:#e9ecef;height:8px;border-radius:4px;overflow:hidden;display:flex;">
            <div style="height:8px;width:{{ '%.1f'|format(lost_pct) }}%;background:#ff6b6b;"></div>
            <div style="height:8px;width:{{ '%.1f'|format(found_pct) }}%;background:#51cf66;"></div>
          </div>
          <div style="display:flex;justify-content:space-between;margin-top:.5rem;font-size:.9rem;color:#666;">
            <span>é—å¤± {{ '%.1f'|format(lost_pct) }}%</span>
            <span>æ‹¾åˆ° {{ '%.1f'|format(found_pct) }}%</span>
          </div>
        </div>
      </div>
      {% endif %}
    {% endfor %}
  </div>
</div>

{# ---------- åœ°ç‚¹ç»Ÿè®¡ ---------- #}
{% if location_stats %}
<div class="card">
  <h3 style="color:#2c3e50;margin-bottom:1.5rem;text-align:center;">ğŸ“ çƒ­é—¨åœ°ç‚¹ç»Ÿè®¡</h3>
  <div style="display:grid;gap:1rem;">
    {% for location, stats in location_stats.items() %}
      {% set l = stats.lost|default(0) %}
      {% set f = stats.found|default(0) %}
      {% set t = l + f %}
      <div style="background:#f8f9fa;padding:1.5rem;border-radius:10px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
          <div style="display:flex;align-items:center;gap:1rem;">
            <div style="background:#667eea;color:#fff;width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2rem;">ğŸ“</div>
            <h4 style="color:#2c3e50;">{{ location }}</h4>
          </div>
          <div style="text-align:right;">
            <div style="font-size:1.2rem;font-weight:bold;color:#667eea;">{{ t }} ä»¶</div>
            <div style="font-size:.9rem;color:#666;">å¤±ç‰©ä¿¡æ¯</div>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
          <div style="display:flex;align-items:center;justify-content:space-between;padding:.8rem;background:rgba(255,154,158,.1);border-radius:8px;">
            <div><div style="color:#dc3545;font-weight:bold;">ğŸ” é—å¤±</div></div>
            <div style="font-size:1.3rem;font-weight:bold;color:#dc3545;">{{ l }}</div>
          </div>
          <div style="display:flex;align-items:center;justify-content:space-between;padding:.8rem;background:rgba(132,250,176,.1);border-radius:8px;">
            <div><div style="color:#28a745;font-weight:bold;">ğŸ“¦ æ‹¾åˆ°</div></div>
            <div style="font-size:1.3rem;font-weight:bold;color:#28a745;">{{ f }}</div>
          </div>
        </div>

        <div style="margin-top:1rem;text-align:center;">
          {% if t >= 5 %}
            <span style="background:#ff4757;color:#fff;padding:4px 12px;border-radius:15px;font-size:.8rem;">ğŸ”¥ çƒ­é—¨åœ°ç‚¹</span>
          {% elif t >= 3 %}
            <span style="background:#ffa502;color:#fff;padding:4px 12px;border-radius:15px;font-size:.8rem;">âš¡ æ´»è·ƒåœ°ç‚¹</span>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>
</div>
{% endif %}

{# ---------- å¿«é€Ÿæ“ä½œ & æç¤º ---------- #}
<div class="card" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;text-align:center;">
  <h3 style="margin-bottom:1rem;">ğŸ’¡ æ¸©é¦¨æç¤º</h3>
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem;">
    <div style="background:rgba(255,255,255,.1);padding:1.5rem;border-radius:10px;">
      <div style="font-size:2rem;margin-bottom:.5rem;">ğŸ“</div>
      <h4 style="margin-bottom:.5rem;">åŠæ—¶æ²Ÿé€š</h4>
      <p style="font-size:.9rem;opacity:.9;">ç•™ä¸‹æœ‰æ•ˆè”ç³»æ–¹å¼ï¼Œä¾¿äºå¤±ä¸»ä¸æ‹¾è·è€…åŠæ—¶å–å¾—è”ç³»</p>
    </div>
    <div style="background:rgba(255,255,255,.1);padding:1.5rem;border-radius:10px;">
      <div style="font-size:2rem;margin-bottom:.5rem;">ğŸ¯</div>
      <h4 style="margin-bottom:.5rem;">æé«˜æ‰¾å›ç‡</h4>
      <p style="font-size:.9rem;opacity:.9;">è¯¦ç»†æè¿°ç‰©å“ç‰¹å¾ä¸å‡†ç¡®åœ°ç‚¹ï¼Œæœ‰åŠ©äºæ›´å¿«æ‰¾å›</p>
    </div>
  </div>
</div>

<div style="text-align:center;padding:2rem 0;">
  <h3 style="color:#2c3e50;margin-bottom:1rem;">å¿«é€Ÿæ“ä½œ</h3>
  <div style="display:flex;gap:1rem;justify-content:center;flex-wrap:wrap;">
    <a href="/register" class="btn">ç™»è®°å¤±ç‰©ä¿¡æ¯</a>
    <a href="/search" class="btn btn-secondary">æœç´¢æŸ¥è¯¢</a>
  </div>
</div>

<script>
  // æ•°å­—æ»šåŠ¨åŠ¨ç”»
  document.addEventListener('DOMContentLoaded', function () {
    const kpis = document.querySelectorAll('.kpi');
    kpis.forEach(el => {
      const target = parseInt(el.dataset.target || el.textContent || '0', 10);
      if (isNaN(target) || target <= 0) return;
      let cur = 0;
      const step = Math.max(1, Math.ceil(target / 30));
      const timer = setInterval(() => {
        cur += step;
        if (cur >= target) { cur = target; clearInterval(timer); }
        el.textContent = cur;
      }, 40);
    });
  });
</script>
{% endblock %}

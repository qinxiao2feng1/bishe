{% extends "base.html" %}
{% block title %}统计信息 - 校园失物招领平台{% endblock %}

{% block content %}
<div class="page-title">
  <h2>统计信息</h2>
  <p>查看平台数据统计，了解失物招领情况 📊</p>
</div>

{# ---------- 顶部概览卡片 ---------- #}
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem;margin-bottom:2rem;">
  <div class="card" style="text-align:center;background:linear-gradient(135deg,#ff9a9e 0%,#fad0c4 100%);color:#721c24;border:none;">
    <div style="font-size:3rem;margin-bottom:.5rem;">🔍</div>
    <h3 class="kpi" data-target="{{ total_lost|default(0) }}" style="font-size:2rem;margin-bottom:.5rem;">{{ total_lost|default(0) }}</h3>
    <p style="font-size:1.1rem;font-weight:500;">遗失物品</p>
  </div>

  <div class="card" style="text-align:center;background:linear-gradient(135deg,#84fab0 0%,#8fd3f4 100%);color:#155724;border:none;">
    <div style="font-size:3rem;margin-bottom:.5rem;">📦</div>
    <h3 class="kpi" data-target="{{ total_found|default(0) }}" style="font-size:2rem;margin-bottom:.5rem;">{{ total_found|default(0) }}</h3>
    <p style="font-size:1.1rem;font-weight:500;">拾到物品</p>
  </div>

  {% set all_total = (total_lost|default(0)) + (total_found|default(0)) %}
  <div class="card" style="text-align:center;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;">
    <div style="font-size:3rem;margin-bottom:.5rem;">📈</div>
    <h3 class="kpi" data-target="{{ all_total }}" style="font-size:2rem;margin-bottom:.5rem;">{{ all_total }}</h3>
    <p style="font-size:1.1rem;font-weight:500;">总计信息</p>
  </div>

  <div class="card" style="text-align:center;background:linear-gradient(135deg,#ffecd2 0%,#fcb69f 100%);color:#8b4513;border:none;">
    <div style="font-size:3rem;margin-bottom:.5rem;">🎯</div>
    {% set rate = 0 if all_total==0 else (total_found / all_total * 100) %}
    <h3 style="font-size:2rem;margin-bottom:.5rem;">{{ '%.1f'|format(rate) }}%</h3>
    <p style="font-size:1.1rem;font-weight:500;">找回率</p>
  </div>
</div>

{# ---------- 类别统计 ---------- #}
<div class="card">
  <h3 style="color:#2c3e50;margin-bottom:1.5rem;text-align:center;">📊 物品类别统计</h3>

  <div style="display:grid;gap:1rem;">
    {% for category in lost_stats.keys() %}
      {% set lost_count  = lost_stats[category]|default(0) %}
      {% set found_count = found_stats[category]|default(0) %}
      {% set total = lost_count + found_count %}
      {% if total > 0 %}
      <div style="background:#f8f9fa;padding:1.5rem;border-radius:10px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
          <div style="display:flex;align-items:center;gap:1rem;">
            <div style="font-size:2rem;">
              {% if category == '钱包' %}💰
              {% elif category == '钥匙' %}🔑
              {% elif category == '书籍' %}📚
              {% elif category == '电子产品' %}📱
              {% else %}📦{% endif %}
            </div>
            <h4 style="color:#2c3e50;">{{ category }}</h4>
          </div>
          <div style="text-align:right;">
            <div style="font-size:1.2rem;font-weight:bold;color:#667eea;">{{ total }} 件</div>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
          <div style="text-align:center;padding:1rem;background:rgba(255,154,158,.1);border-radius:8px;">
            <div style="font-size:1.5rem;font-weight:bold;color:#dc3545;margin-bottom:.5rem;">{{ lost_count }}</div>
            <div style="color:#666;">遗失</div>
          </div>
          <div style="text-align:center;padding:1rem;background:rgba(132,250,176,.1);border-radius:8px;">
            <div style="font-size:1.5rem;font-weight:bold;color:#28a745;margin-bottom:.5rem;">{{ found_count }}</div>
            <div style="color:#666;">拾到</div>
          </div>
        </div>

        {# 进度条：按比例展示 #}
        {% set lost_pct  = 0 if total==0 else (lost_count/total*100) %}
        {% set found_pct = 100 - lost_pct %}
        <div style="margin-top:1rem;">
          <div style="background:#e9ecef;height:8px;border-radius:4px;overflow:hidden;display:flex;">
            <div style="height:8px;width:{{ '%.1f'|format(lost_pct) }}%;background:#ff6b6b;"></div>
            <div style="height:8px;width:{{ '%.1f'|format(found_pct) }}%;background:#51cf66;"></div>
          </div>
          <div style="display:flex;justify-content:space-between;margin-top:.5rem;font-size:.9rem;color:#666;">
            <span>遗失 {{ '%.1f'|format(lost_pct) }}%</span>
            <span>拾到 {{ '%.1f'|format(found_pct) }}%</span>
          </div>
        </div>
      </div>
      {% endif %}
    {% endfor %}
  </div>
</div>

{# ---------- 地点统计 ---------- #}
{% if location_stats %}
<div class="card">
  <h3 style="color:#2c3e50;margin-bottom:1.5rem;text-align:center;">📍 热门地点统计</h3>
  <div style="display:grid;gap:1rem;">
    {% for location, stats in location_stats.items() %}
      {% set l = stats.lost|default(0) %}
      {% set f = stats.found|default(0) %}
      {% set t = l + f %}
      <div style="background:#f8f9fa;padding:1.5rem;border-radius:10px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
          <div style="display:flex;align-items:center;gap:1rem;">
            <div style="background:#667eea;color:#fff;width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2rem;">📍</div>
            <h4 style="color:#2c3e50;">{{ location }}</h4>
          </div>
          <div style="text-align:right;">
            <div style="font-size:1.2rem;font-weight:bold;color:#667eea;">{{ t }} 件</div>
            <div style="font-size:.9rem;color:#666;">失物信息</div>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
          <div style="display:flex;align-items:center;justify-content:space-between;padding:.8rem;background:rgba(255,154,158,.1);border-radius:8px;">
            <div><div style="color:#dc3545;font-weight:bold;">🔍 遗失</div></div>
            <div style="font-size:1.3rem;font-weight:bold;color:#dc3545;">{{ l }}</div>
          </div>
          <div style="display:flex;align-items:center;justify-content:space-between;padding:.8rem;background:rgba(132,250,176,.1);border-radius:8px;">
            <div><div style="color:#28a745;font-weight:bold;">📦 拾到</div></div>
            <div style="font-size:1.3rem;font-weight:bold;color:#28a745;">{{ f }}</div>
          </div>
        </div>

        <div style="margin-top:1rem;text-align:center;">
          {% if t >= 5 %}
            <span style="background:#ff4757;color:#fff;padding:4px 12px;border-radius:15px;font-size:.8rem;">🔥 热门地点</span>
          {% elif t >= 3 %}
            <span style="background:#ffa502;color:#fff;padding:4px 12px;border-radius:15px;font-size:.8rem;">⚡ 活跃地点</span>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>
</div>
{% endif %}

{# ---------- 快速操作 & 提示 ---------- #}
<div class="card" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;text-align:center;">
  <h3 style="margin-bottom:1rem;">💡 温馨提示</h3>
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem;">
    <div style="background:rgba(255,255,255,.1);padding:1.5rem;border-radius:10px;">
      <div style="font-size:2rem;margin-bottom:.5rem;">📞</div>
      <h4 style="margin-bottom:.5rem;">及时沟通</h4>
      <p style="font-size:.9rem;opacity:.9;">留下有效联系方式，便于失主与拾获者及时取得联系</p>
    </div>
    <div style="background:rgba(255,255,255,.1);padding:1.5rem;border-radius:10px;">
      <div style="font-size:2rem;margin-bottom:.5rem;">🎯</div>
      <h4 style="margin-bottom:.5rem;">提高找回率</h4>
      <p style="font-size:.9rem;opacity:.9;">详细描述物品特征与准确地点，有助于更快找回</p>
    </div>
  </div>
</div>

<div style="text-align:center;padding:2rem 0;">
  <h3 style="color:#2c3e50;margin-bottom:1rem;">快速操作</h3>
  <div style="display:flex;gap:1rem;justify-content:center;flex-wrap:wrap;">
    <a href="/register" class="btn">登记失物信息</a>
    <a href="/search" class="btn btn-secondary">搜索查询</a>
  </div>
</div>

<script>
  // 数字滚动动画
  document.addEventListener('DOMContentLoaded', function () {
    const kpis = document.querySelectorAll('.kpi');
    kpis.forEach(el => {
      const target = parseInt(el.dataset.target || el.textContent || '0', 10);
      if (isNaN(target) || target <= 0) return;
      let cur = 0;
      const step = Math.max(1, Math.ceil(target / 30));
      const timer = setInterval(() => {
        cur += step;
        if (cur >= target) { cur = target; clearInterval(timer); }
        el.textContent = cur;
      }, 40);
    });
  });
</script>
{% endblock %}

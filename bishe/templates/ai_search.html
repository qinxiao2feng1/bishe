{% extends "base.html" %}
{% block title %}AI 도우미 - 분실물 도와드려요{% endblock %}

{% block content %}
<div class="page-title">
  <h2>🤖 AI 분실물 도우미</h2>
  <p>찾고 싶은 물품 또는 습득한 물품 정보를 입력하면 안내해 드립니다.</p>
</div>

<div class="card" style="max-width: 960px; margin: 0 auto;">
  <!-- 채팅창 -->
  <div id="chat-box" style="height: 420px; overflow-y: auto; border: 2px solid #e3e8f0; border-radius: 12px; padding: 16px; background: #fafbff;">
    <div class="msg ai">
      <div class="bubble">
        안녕하세요! 저는 AI 분실물 도우미입니다 😊<br>
        다음과 같이 물어보실 수 있어요:<br>
        • 도서관에서 검정 지갑을 잃어버렸어요. 어떻게 찾죠?<br>
        • 열쇠를 주웠는데 어떻게 등록하나요?<br>
        • 전자제품 분실물만 검색하고 싶어요.
      </div>
    </div>
  </div>

  <!-- 입력 영역 -->
  <div style="display: grid; grid-template-columns: 1fr auto; gap: 12px; margin-top: 14px;">
    <textarea id="chat-input" class="form-control" rows="2" placeholder="예: 학생식당에서 파란 카드 지갑을 잃어버렸어요… (Enter: 전송 / Shift+Enter: 줄바꿈)"></textarea>
    <div style="display: flex; flex-direction: column; gap: 8px;">
      <button id="send-btn" class="btn">전송</button>
      <button id="clear-btn" class="btn btn-secondary" type="button" title="대화 지우기">지우기</button>
    </div>
  </div>

  <!-- 추천 문구 -->
  <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px;">
    <button class="btn btn-secondary quick" type="button" data-text="도서관에서 검정 지갑을 잃어버렸어요. 어떻게 찾을 수 있을까요?">📚 도서관 지갑 분실</button>
    <button class="btn btn-secondary quick" type="button" data-text="열쇠를 주웠는데 어디에서 등록하나요?">🔑 열쇠 습득</button>
    <button class="btn btn-secondary quick" type="button" data-text="분실물을 되찾기 위한 단계별 안내를 알려주세요.">📋 찾는 방법 안내</button>
    <button class="btn btn-secondary quick" type="button" data-text="전자제품 분실물을 검색하고 연락하는 방법을 알려주세요.">📱 전자제품 검색</button>
  </div>
</div>

<style>
  .msg { display: flex; margin: 10px 0; }
  .msg.ai { justify-content: flex-start; }
  .msg.me { justify-content: flex-end; }
  .bubble {
    max-width: 78%;
    padding: 12px 14px;
    border-radius: 14px;
    line-height: 1.6;
    word-break: break-word;
    white-space: pre-wrap;
    box-shadow: 0 6px 18px rgba(0,0,0,.06);
    font-size: 15px;
  }
  .msg.ai .bubble {
    background: #ffffff;
    border: 1px solid #e8ecf4;
  }
  .msg.me .bubble {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #fff;
    border: none;
  }
  .thinking {
    display: inline-block;
    width: 1.1em;
    text-align: center;
    animation: blink 1s infinite steps(2);
  }
  @keyframes blink { 50% { opacity: 0.25; } }
</style>

<script>
  const chatBox = document.getElementById('chat-box');
  const inputEl = document.getElementById('chat-input');
  const sendBtn = document.getElementById('send-btn');
  const clearBtn = document.getElementById('clear-btn');
  const quickBtns = document.querySelectorAll('.quick');

  function addBubble(role, text) {
    const wrap = document.createElement('div');
    wrap.className = 'msg ' + (role === 'me' ? 'me' : 'ai');
    const b = document.createElement('div');
    b.className = 'bubble';
    b.textContent = text;
    wrap.appendChild(b);
    chatBox.appendChild(wrap);
    chatBox.scrollTop = chatBox.scrollHeight;
    return b;
  }

  function setLoading(bubble, loading) {
    if (!bubble) return;
    if (loading) {
      bubble.dataset.orig = bubble.textContent;
      bubble.innerHTML = '생각 중 <span class="thinking">…</span>';
    } else {
      bubble.textContent = bubble.dataset.orig;
    }
  }

  async function sendMessage() {
    const content = (inputEl.value || '').trim();
    if (!content) return;

    addBubble('me', content);
    inputEl.value = '';

    const aiBubble = addBubble('ai', '생각 중…');
    setLoading(aiBubble, true);

    try {
      const resp = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: content })
      });

      const data = await resp.json();
      setLoading(aiBubble, false);

      if (!resp.ok || data.error) {
        aiBubble.textContent = '❌ 오류: ' + (data.error || ('HTTP ' + resp.status));
        return;
      }

      aiBubble.textContent = data?.choices?.[0]?.message?.content || '응답이 없습니다.';
    } catch (err) {
      setLoading(aiBubble, false);
      aiBubble.textContent = '❌ 통신 실패: ' + err;
    }
  }

  sendBtn.addEventListener('click', sendMessage);
  inputEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  });

  clearBtn.addEventListener('click', () => {
    chatBox.innerHTML = '';
    addBubble('ai', '대화를 초기화했습니다. 무엇을 도와드릴까요? 😊');
  });

  quickBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      inputEl.value = btn.dataset.text || '';
      inputEl.focus();
    });
  });
</script>
{% endblock %}

{% extends "layout.html" %}
{% block title %}AI 물품 검색 도우미{% endblock %}

{% block content %}
<h2>AI 물품 검색 도우미 🤖</h2>
<p>찾고자 하는 물품을 입력하세요. 제가 도와드릴게요!</p>

<div id="chat" style="white-space: pre-wrap; border:1px solid #ddd; padding:10px; min-height:200px; margin-bottom:10px;"></div>
<textarea id="input" rows="3" style="width:100%;" placeholder="예: 노트북, 지갑, 카드 등…"></textarea>
<button id="send" class="btn btn-primary" style="margin-top:10px;">보내기</button>

<script>
const chatDiv = document.getElementById('chat');
const inputEl = document.getElementById('input');
const sendBtn = document.getElementById('send');

// ⚠️ 절대 실제 Key를 여기에 넣지 마세요！只是测试时可以使用
const OPENAI_API_KEY = "sk-你的测试key";

function appendMessage(role, text) {
  const div = document.createElement('div');
  div.innerHTML = `<b>${role}：</b>${text}`;
  chatDiv.appendChild(div);
  chatDiv.scrollTop = chatDiv.scrollHeight;
}

async function sendMessage() {
  const content = inputEl.value.trim();
  if (!content) return;
  inputEl.value = '';

  appendMessage('나', content);

  try {
    const resp = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + OPENAI_API_KEY
      },
      body: JSON.stringify({
        model: "gpt-3.5-turbo",
        messages: [
          { role: "system", content: "너는 AI 물품 검색 도우미야. 분실물 찾기와 추천을 도와줘." },
          { role: "user", content: content }
        ]
      })
    });
    const data = await resp.json();
    const reply = data.choices?.[0]?.message?.content || "답변이 없습니다.";
    appendMessage("AI 도우미", reply);
  } catch (err) {
    appendMessage("AI 도우미", "요청 오류: " + err);
  }
}

sendBtn.addEventListener('click', sendMessage);
inputEl.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

appendMessage("AI 도우미", "안녕하세요! AI 도우미입니다. 어떤 물품을 찾고 싶으세요?");
</script>
{% endblock %}
